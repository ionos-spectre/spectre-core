kind: pipeline
name: default

workspace:
  path: /drone/src

steps:
- name: install
  image: ruby:3.0
  commands:
  - bundle install

- name: test
  image: ruby:3.0
  commands:
  - bundle exec rspec spec

- name: build
  image: ruby:3.0
  commands:
  - bundle exec rake build
  # when:
  #   branch:
  #   - main
  #   ref:
  #   - refs/tags/*

- name: deploy
  image: ruby:3.0
  environment:
    RUBYGEMS_APIKEY:
      from_secret: rubygems_apikey
  commands:
  - mkdir ~/.gem
  - 'echo -e "---\n:rubygems_api_key: $RUBYGEMS_APIKEY" > ~/.gem/credentials'
  - chmod 0600 ~/.gem/credentials
  - gem push pkg/*.gem
  # when:
  #   ref:
  #   - refs/tags/*

# trigger:
#   event:
#   - push