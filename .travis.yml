language: ruby

services:
  - docker

rvm:
 - 2.5

dist: xenial
os: linux

branches:
  only:
   - master
   - /^\d+\.\d+\.\d+(?:-\S*)?$/

# before_install:
#   - bkp_pwd=$(pwd)
#   - cd ./testing/docker/spectre # --project-directory does not work!
#   - docker-compose up -d
#   - cd $bkp_pwd

jobs:
  include:
    - stage: test
      script:
        - bundle exec rspec spec
        # - bundle exec spectre -c testing/spectre/spectre.yml
    - stage: build
      script:
        - bundle exec rake build
    - stage: publish gem
      if: branch =~ /^\d\.\d\.\d(?:-\S*)?$/
      script:
       - bundle exec rake build
       - 'echo -e "---\n:rubygems_api_key: $RUBYGEMS_APIKEY" > ~/.gem/credentials'
       - chmod 0600 ~/.gem/credentials
       - gem push pkg/*.gem
    - stage: publish versioned docker image
      if: branch =~ /^\d\.\d\.\d(?:-\S*)?$/
      script:
       - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
       - docker build -t $DOCKER_USERNAME/spectre:$TRAVIS_BRANCH .
       - docker images
       - docker push $DOCKER_USERNAME/spectre:$TRAVIS_BRANCH
    - stage: publish latest docker image
      script:
       - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
       - docker build -t $DOCKER_USERNAME/spectre .
       - docker push $DOCKER_USERNAME/spectre